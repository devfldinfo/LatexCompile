name: Compile and commit all LaTeX PDFs (Docker)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-latex:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    container:
      image: ghcr.io/xu-cheng/texlive-full:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compile all LaTeX files (XeLaTeX)
        shell: bash
        run: |
          FAILED=0

          find . -name "*.tex" -type f -print0 | while IFS= read -r -d '' texfile; do
            dir="$(dirname "$texfile")"
            file="$(basename "$texfile")"

            echo "Compiling $texfile"

            latexmk \
              -xelatex \
              -interaction=nonstopmode \
              -halt-on-error \
              -cd \
              "$dir/$file" || FAILED=1
          done

          exit $FAILED

      - name: Clean auxiliary files
        run: |
          find . -type f \( \
            -name "*.aux" -o \
            -name "*.log" -o \
            -name "*.out" -o \
            -name "*.fls" -o \
            -name "*.fdb_latexmk" \
          \) -delete

      - name: Commit generated PDFs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git status --porcelain | grep -E '\.pdf$'; then
            git add '**/*.pdf'
            git commit -m "Auto-compile LaTeX PDFs"
            git push
          else
            echo "No PDF changes to commit"
          fi
